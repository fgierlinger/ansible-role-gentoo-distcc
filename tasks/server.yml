
  - name: Enable ccache on distcc server
    shell:
      cmd: distcc-config --set-env DISTCC_CMDLIST "/etc/distcc/cmdlist"
    when: "{{ ccache.stat.exists }}"
    changed_when: False
    notify:
      - Restart distccd
    tags: [config]

  - name: Check /etc/distcc/cmdlist
    copy:
      content: ""
      dest: "/etc/distcc/cmdlist"
      force: no
    tags: [config]

  - name: Set up /etc/distcc/cmdlist
    lineinfile:
      dest: /etc/distcc/cmdlist
      line: "{{ item }}"
      state: "present"
    with_items: "{{ distcc.cmdlist }}"
    notify:
      - Restart distccd
    tags: [config]

  - name: Set up server
    lineinfile:
      dest: /etc/conf.d/distccd
      line: "DISTCCD_OPTS=\"${DISTCCD_OPTS} {{ item }}\""
    with_items: "{{ distcc.server_options }}"  
    notify:
      - Restart distccd
    tags: [config]

  - name: Setup "distccd" service
    service:
      name: "distccd"
      enabled: "yes"
      state: "started"
      runlevel: "default"
    tags: [services]

  - meta: flush_handlers
